<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Test Bot Screenshot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">
    <div class="container">
        <h3>Test Bot Screenshot</h3>
        <div class="mb-3">
            <label class="form-label">Chiedi al bot</label>
            <input id="question" type="text" class="form-control" placeholder="Inserisci domanda...">
        </div>
        <div class="mb-3">
            <button id="captureBtn" class="btn btn-secondary">Cattura schermo</button>
            <label for="fileInput" class="btn btn-outline-secondary ms-2">Carica immagine</label>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <button id="sendBtn" class="btn btn-primary ms-2">Invia</button>
        </div>
        <div class="mb-3">
            <img id="preview" style="max-width: 300px; display: none;" />
        </div>
        <div id="output"></div>
    </div>

    <script>
        let capturedBlob = null, fileId = null;

        // SCREENSHOT BUTTON
        document.getElementById('captureBtn').onclick = async function () {
            let stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            let track = stream.getVideoTracks()[0];
            let imageCapture = new ImageCapture(track);
            let bitmap = await imageCapture.grabFrame();

            let canvas = document.createElement('canvas');
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            let ctx = canvas.getContext('2d');
            ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(async blob => {
                capturedBlob = blob;
                // Preview
                document.getElementById('preview').src = URL.createObjectURL(blob);
                document.getElementById('preview').style.display = '';
                // Upload to server
                let formData = new FormData();
                formData.append("file", blob, "screenshot.jpg");
                let res = await fetch('/upload', { method: 'POST', body: formData });
                let data = await res.json();
                fileId = data.file_id;

                // Workaround focus
                setTimeout(() => {
                    document.getElementById('question').focus();
                    window.focus();
                }, 250);
            }, 'image/jpeg', 0.85);
            track.stop();
        };

        // FILE INPUT (FROM DISK)
        document.getElementById('fileInput').onchange = async function (e) {
            let file = e.target.files[0];
            if (!file) return;
            capturedBlob = file;
            // Preview
            document.getElementById('preview').src = URL.createObjectURL(file);
            document.getElementById('preview').style.display = '';
            // Upload to server
            let formData = new FormData();
            formData.append("file", file, file.name);
            let res = await fetch('/upload', { method: 'POST', body: formData });
            let data = await res.json();
            fileId = data.file_id;
        };

        // INVIA BUTTON
        document.getElementById('sendBtn').onclick = async function () {
            let question = document.getElementById('question').value;
            if (!fileId) {
                alert("Carica un'immagine o cattura uno screenshot prima di inviare!");
                return;
            }
            let res = await fetch('/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_id: fileId, text: question })
            });
            let data = await res.json();
            document.getElementById('output').innerText = JSON.stringify(data, null, 2);
        };

        // Allow clicking label to trigger file input
        document.querySelector('label[for="fileInput"]').onclick = function() {
            document.getElementById('fileInput').click();
        };
    </script>
</body>

</html>
